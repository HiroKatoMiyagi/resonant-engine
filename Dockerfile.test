# Dockerfile for Context Assembler Testing
FROM python:3.11-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Copy all modules
COPY context_assembler/ /app/context_assembler/
COPY memory_store/ /app/memory_store/
COPY retrieval/ /app/retrieval/
COPY bridge/ /app/bridge/
COPY backend/app/ /app/app/
COPY tests/context_assembler/ /app/tests/context_assembler/
COPY test_context_assembler_simple.py /app/

# Install Python dependencies
RUN pip install --no-cache-dir \
    pytest==9.0.1 \
    pytest-asyncio==1.3.0 \
    pytest-cov==7.0.0 \
    asyncpg==0.30.0 \
    anthropic>=0.73.0 \
    fastapi==0.104.1 \
    pydantic==2.5.0 \
    numpy \
    tiktoken \
    python-dotenv

# Set Python path
ENV PYTHONPATH=/app

# Create empty __init__.py for app module to fix imports
RUN touch /app/app/__init__.py /app/app/repositories/__init__.py /app/app/models/__init__.py

# Temporarily disable context_assembler/__init__.py imports to avoid backend dependency
RUN echo '"""Context Assembler"""' > /app/context_assembler/__init__.py

CMD ["python", "test_context_assembler_simple.py"]
