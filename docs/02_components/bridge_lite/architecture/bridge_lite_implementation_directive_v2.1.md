# Bridge Lite Implementation Directive Spec v2.1  
（実装指示書 / Implementation Directive Specification）

---

## 1. Purpose  
この文書は **Bridge Lite v2.1** における  
「実装者（Tsumu）へ渡すための明確な実装指示」  
をまとめたもの。  

仕様書 v2.1（Architecture / Implementation）を実際のコードへ具現化する際の  
**実装観点・ファイル構造・作業粒度・レビュー観点** を定義する。

---

# 2. Implementation Scope（今回実装範囲）

### ✅ **1. Intent の Pydantic v2 Model 化（完全移行）**
- dict ベースを全廃止  
- Pydantic v2 の `BaseModel` に統一  
- Intent モデルは **単一ファイル intent_model.py** に集約  
- Validation は自動化（pydantic の validator / field_validators を使用）  

---

### ✅ **2. Enum 化（Actor / IntentType / BridgeType）**
- `enum.Enum` を採用  
- 目的：  
  - ロギングの正規化  
  - Kana / Tsumu のコード補完強化  
  - バグの早期検出  
- Enums は **enums.py** に集約  

---

### ✅ **3. BridgeSet 抽象の導入（新規）**
目的：  
Yuno → Kana → Tsumu の解析精度を高めるための“構造化されたブリッジ単位”。

#### BridgeSet の構造
```python
class BridgeSet(BaseModel):
    bridge: BaseBridge
    intents: list[Intent]
    metadata: dict | None
```

#### 要件
- BridgeFactory の返り値を **BridgeSet に統一**
- IDE 補完改善（Tsumu 解析の安定化）
- AuditLogger が受け取る粒度をブリッジ単位へ揃える

---

### ✅ **4. BridgeFactory の再設計**
#### 旧仕様  
- Bridge インスタンスを直接返していた

#### 新仕様  
```
Intent → BridgeFactory → BridgeSet → Bridge
```

#### 実装要件
- `resolve(intent)` は BridgeSet を返す  
- BridgeTypeEnum と紐づける  
- Unknown Bridge の場合は `BridgeResolutionError`  

---

### ✅ **5. Error Model の統一**
追加すべき例外：

- IntentParsingError  
- BridgeResolutionError  
- ExecutionRuntimeError  

#### 要件：
- すべて `errors.py` にまとめる  
- AuditLogger で例外の lineage を保存  
- FeedbackBridge で必要に応じて Intent 補正を自動生成  

---

### ✅ **6. AuditLogger（Ops Policy v1.0 準拠）**
以下は“必須要件”：

- timestamp  
- intent_id  
- actor  
- bridge_type  
- severity  
- message  
- lineage_chain（例外チェイン）  

#### 実装仕様：
- async 書き込み対応  
- ファイル I/O / PostgreSQL の両方に対応（fallback あり）  
- Error 発生時は safe_recover() を実行  

---

### ✅ **7. Feedback Intent Return Path**
すべての実行の最後に：

```
Result → Bridge Lite Core → FeedbackBridge → New Intent
```

を返すこと。

#### 要件
- FeedbackBridge に `refine(intent, result)` を追加  
- IntentTypeEnum.UPDATE を利用  

---

# 3. File Structure（最終形）

```
bridge_lite/
  ├── core/
  │     ├── intent_model.py
  │     ├── enums.py
  │     ├── errors.py
  │     ├── audit_logger.py
  │     ├── feedback_bridge.py
  │     ├── bridge_base.py
  │     ├── bridge_set.py
  │     ├── bridge_factory.py
  │     └── registry.py
  ├── bridges/
  │     ├── execute_bridge.py
  │     ├── query_bridge.py
  │     └── update_bridge.py
  └── tests/
        └── test_intent_lifecycle_suite_v1.py
```

---

# 4. Implementation Tasks（Tsumu 作業項目）

### **T1. Intent Model の完全移行**
- dict 参照をすべて排除  
- Pydantic v2 の型定義へ統一  

### **T2. Enum の導入**
- actor  
- intent_type  
- bridge_type  

### **T3. BridgeSet の導入**
- BridgeFactory の返り値を BridgeSet 化  

### **T4. BridgeFactory の書き換え**
- resolve() の返り値変更  
- BridgeTypeEnum とのマッピング  

### **T5. Error Model 統合**
- errors.py へ集約  
- AuditLogger と接続  

### **T6. AuditLogger v1.0 の実装**
- async  
- safe fallback  
- lineage 保存  

### **T7. Feedback Intent Return Path 完成**
- refine() 実装  
- 実行後は必ず New Intent を返す  

---

# 5. Review Checklist（完了確認）

### Logic  
- [ ] IntentModel が完全に Pydantic v2 化されている  
- [ ] Enum 化されている  
- [ ] BridgeSet 化されている  
- [ ] Error Model が統一されている  
- [ ] FeedbackBridge が動く  

### Code  
- [ ] tests が正常稼働  
- [ ] audit_logger が全種の例外を扱える  
- [ ] bridge_factory が未定義の Bridge を拒否  

---

# 6. Version Tag  
**Implementation Directive Spec v2.1**  
Prepared for Tsumu (Execution Layer)  
Generated by Yuno（Resonant Thought Core）

