# Backend APIçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ

**å®Ÿè¡Œæ—¥**: 2025-11-30  
**å®Ÿè¡Œè€…**: Kiro AI Assistant  
**ãƒ†ã‚¹ãƒˆå¯¾è±¡**: Backend APIçµ±åˆï¼ˆ14ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰

---

## ğŸ“‹ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚µãƒãƒªãƒ¼

### å®Ÿè¡Œç’°å¢ƒ
- Docker version: ç¢ºèªæ¸ˆã¿
- PostgreSQL version: 15-alpine
- Backend API version: 2.0.0
- Database: resonant_dashboard

### ãƒ†ã‚¹ãƒˆçµæœæ¦‚è¦

| ã‚«ãƒ†ã‚´ãƒª | åˆæ ¼ | å¤±æ•— | åˆè¨ˆ | åˆæ ¼ç‡ |
|---------|------|------|------|--------|
| Contradiction Detection | 1 | 2 | 3 | 33% |
| Re-evaluation | 0 | 1 | 1 | 0% |
| Choice Preservation | 4 | 0 | 4 | 100% |
| Memory Lifecycle | 0 | 1 | 1 | 0% |
| Dashboard Analytics | 1 | 2 | 3 | 33% |
| å¾Œæ–¹äº’æ›æ€§ | 2 | 0 | 2 | 100% |
| **åˆè¨ˆ** | **8** | **6** | **14** | **57%** |

---

## âœ… åˆæ ¼ã—ãŸãƒ†ã‚¹ãƒˆ

### 1. Contradiction Detection - æœªè§£æ±ºçŸ›ç›¾å–å¾—
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/contradiction/pending`

**ãƒ†ã‚¹ãƒˆçµæœ**:
```bash
$ curl 'http://localhost:8000/api/v1/contradiction/pending?user_id=test_user'
HTTP Status: 200 OK
Response: {"contradictions":[],"count":0}
```

**åˆ¤å®š**: âœ… åˆæ ¼
- HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: 200 OK
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼: æ­£å¸¸
- ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã§ã¯ãªã„ï¼ˆå®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªï¼‰

---

### 2. Choice Preservation - å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ4/4ï¼‰

#### 2.1 æœªæ±ºå®šé¸æŠè‚¢å–å¾—
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/memory/choice-points/pending`

**ãƒ†ã‚¹ãƒˆçµæœ**:
```bash
HTTP Status: 200 OK
Response: {"choice_points":[],"count":0}
```

**åˆ¤å®š**: âœ… åˆæ ¼

#### 2.2 é¸æŠè‚¢ä½œæˆ
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/memory/choice-points/`

**ãƒ†ã‚¹ãƒˆçµæœ**:
```bash
HTTP Status: 200 OK
Created ID: d39781cc-aa1f-4497-a88b-6de77ca7e266
```

**åˆ¤å®š**: âœ… åˆæ ¼

#### 2.3 é¸æŠæ±ºå®š
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `PUT /api/v1/memory/choice-points/{id}/decide`

**ãƒ†ã‚¹ãƒˆçµæœ**:
```bash
HTTP Status: 200 OK
Selected: A
Decided At: 2025-11-30T09:59:59.277578+00:00
Rejection Reason for B: "Bã¯ä¸è¦"
```

**åˆ¤å®š**: âœ… åˆæ ¼
- é¸æŠãŒæ­£ã—ãä¿å­˜ã•ã‚Œã‚‹
- å´ä¸‹ç†ç”±ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã‚‹
- decided_atãŒè¨­å®šã•ã‚Œã‚‹

#### 2.4 é¸æŠè‚¢æ¤œç´¢
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/memory/choice-points/search`

**ãƒ†ã‚¹ãƒˆçµæœ**:
```bash
HTTP Status: 200 OK
Found: 1 result with tag "integration-test"
```

**åˆ¤å®š**: âœ… åˆæ ¼

---

### 3. Dashboard Analytics - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/dashboard/timeline`

**ãƒ†ã‚¹ãƒˆçµæœ**:
```bash
HTTP Status: 200 OK
```

**åˆ¤å®š**: âœ… åˆæ ¼

---

### 4. å¾Œæ–¹äº’æ›æ€§ãƒ†ã‚¹ãƒˆ

#### 4.1 æ—¢å­˜Messages API
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/messages`

**ãƒ†ã‚¹ãƒˆçµæœ**:
```bash
HTTP Status: 200 OK
Total: 22 messages
Items: 1 (limit=1)
```

**åˆ¤å®š**: âœ… åˆæ ¼
- æ—¢å­˜APIãŒæ­£å¸¸ã«å‹•ä½œ
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ãŒå¤‰ã‚ã£ã¦ã„ãªã„

#### 4.2 æ—¢å­˜Intents API
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/intents`

**ãƒ†ã‚¹ãƒˆçµæœ**:
```bash
HTTP Status: 200 OK
```

**åˆ¤å®š**: âœ… åˆæ ¼

---

## âŒ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆ

### 1. Contradiction Detection - IntentçŸ›ç›¾ãƒã‚§ãƒƒã‚¯
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/contradiction/check`

**ã‚¨ãƒ©ãƒ¼**:
```json
{
  "detail": "Failed to check contradictions: badly formed hexadecimal UUID string"
}
```

**HTTP Status**: 500 Internal Server Error

**åŸå› **: 
- ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã—ãŸ`intent_id`ãŒæœ‰åŠ¹ãªUUIDå½¢å¼ã§ã¯ãªã„
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã—ãªã„Intentã‚’å‚ç…§ã—ã¦ã„ã‚‹

**å¯¾å¿œç­–**:
- æœ‰åŠ¹ãªUUIDå½¢å¼ã®intent_idã‚’ä½¿ç”¨
- ã¾ãŸã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã™ã‚‹Intentã‚’ä½¿ç”¨

**å„ªå…ˆåº¦**: ä¸­ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å•é¡Œï¼‰

---

### 2. Contradiction Detection - çŸ›ç›¾è§£æ±º
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `PUT /api/v1/contradiction/{id}/resolve`

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æœªãƒ†ã‚¹ãƒˆï¼ˆçŸ›ç›¾ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ãŸã‚ï¼‰

**åŸå› **: 
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«çŸ›ç›¾ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„
- Test 1ã§çŸ›ç›¾ãŒæ¤œå‡ºã•ã‚Œãªã‹ã£ãŸ

**å¯¾å¿œç­–**:
- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥
- ã¾ãŸã¯ã€å®Ÿéš›ã«çŸ›ç›¾ã‚’æ¤œå‡ºã—ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆ

**å„ªå…ˆåº¦**: ä½ï¼ˆæ©Ÿèƒ½ã¯å®Ÿè£…æ¸ˆã¿ï¼‰

---

### 3. Re-evaluation - Intentå†è©•ä¾¡
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/intent/reeval`

**ã‚¨ãƒ©ãƒ¼**:
```json
{
  "detail": [
    {
      "loc": ["body", "intent_id"],
      "msg": "field required",
      "type": "value_error.missing"
    }
  ]
}
```

**HTTP Status**: 422 Unprocessable Entity

**åŸå› **: 
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®å½¢å¼ãŒä¸æ­£
- ã¾ãŸã¯ã€å­˜åœ¨ã—ãªã„Intentã‚’å‚ç…§

**å¯¾å¿œç­–**:
- æ­£ã—ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼ã§å†ãƒ†ã‚¹ãƒˆ
- æœ‰åŠ¹ãªintent_idã‚’ä½¿ç”¨

**å„ªå…ˆåº¦**: ä¸­ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®å•é¡Œï¼‰

---

### 4. Memory Lifecycle - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/memory/lifecycle/status`

**ã‚¨ãƒ©ãƒ¼**:
```json
{
  "detail": "ImportanceScorer.__init__() missing 1 required positional argument: 'pool'"
}
```

**HTTP Status**: 500 Internal Server Error

**åŸå› **: 
- `ImportanceScorer`ã®åˆæœŸåŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³
- `backend/app/dependencies.py`ã®å®Ÿè£…ã«å•é¡Œ

**å¯¾å¿œç­–**:
```python
# backend/app/dependencies.py
def get_capacity_manager():
    pool = get_db_pool()
    compression_service = get_compression_service()
    scorer = ImportanceScorer(pool=pool)  # â† poolãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
    return CapacityManager(
        pool=pool,
        compression_service=compression_service,
        scorer=scorer
    )
```

**å„ªå…ˆåº¦**: é«˜ï¼ˆå®Ÿè£…ã®ä¿®æ­£ãŒå¿…è¦ï¼‰

---

### 5. Dashboard Analytics - ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/dashboard/overview`

**ã‚¨ãƒ©ãƒ¼**:
```json
{
  "detail": "Failed to get system overview: invalid input for query argument $1: 1 (expected str, got int)"
}
```

**HTTP Status**: 500 Internal Server Error

**åŸå› **: 
- SQLã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‹ãŒä¸ä¸€è‡´
- DashboardServiceã®å®Ÿè£…ã«å•é¡Œ

**å¯¾å¿œç­–**:
- SQLã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‹ã‚’ä¿®æ­£
- ã¾ãŸã¯ã€DashboardServiceã®å®Ÿè£…ã‚’ç¢ºèª

**å„ªå…ˆåº¦**: ä¸­ï¼ˆæ©Ÿèƒ½ã¯éƒ¨åˆ†çš„ã«å‹•ä½œï¼‰

---

### 6. Dashboard Analytics - ä¿®æ­£å±¥æ­´
**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/dashboard/corrections`

**ã‚¨ãƒ©ãƒ¼**:
```json
{
  "detail": "Failed to get corrections: ..."
}
```

**HTTP Status**: 500 Internal Server Error

**åŸå› **: 
- DashboardServiceã®å®Ÿè£…ã«å•é¡Œ
- ã¾ãŸã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®ä¸ä¸€è‡´

**å¯¾å¿œç­–**:
- DashboardServiceã®å®Ÿè£…ã‚’ç¢ºèª
- ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è©³ç´°ã«ç¢ºèª

**å„ªå…ˆåº¦**: ä¸­

---

## ğŸ¯ E2Eãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆçµæœ

### Test 3.2: é¸æŠè‚¢ä½œæˆã‹ã‚‰æ±ºå®šã¾ã§

**ã‚·ãƒŠãƒªã‚ª**:
1. é¸æŠè‚¢ã‚’ä½œæˆ âœ…
2. æœªæ±ºå®šä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã‚‹ âœ…
3. é¸æŠã‚’æ±ºå®šï¼ˆå´ä¸‹ç†ç”±ä»˜ãï¼‰ âœ…
4. æ¤œç´¢ã§å–å¾—ã§ãã‚‹ âœ…

**å®Ÿè¡Œçµæœ**:
```
Step 1: é¸æŠè‚¢ä½œæˆ
  Created ID: d39781cc-aa1f-4497-a88b-6de77ca7e266
  Question: "çµ±åˆãƒ†ã‚¹ãƒˆé¸æŠ"

Step 2: æœªæ±ºå®šä¸€è¦§ç¢ºèª
  Count: 1
  Has Test Choice: true

Step 3: é¸æŠæ±ºå®š
  Selected: A
  Decided At: 2025-11-30T09:59:59.277578+00:00

Step 4: æ¤œç´¢ç¢ºèª
  Count: 1
  Found: true
```

**åˆ¤å®š**: âœ… å®Œå…¨åˆæ ¼

**è©•ä¾¡**:
- å…¨ã‚¹ãƒ†ãƒƒãƒ—ãŒæ­£å¸¸ã«å‹•ä½œ
- å´ä¸‹ç†ç”±ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã‚‹
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹
- æ¤œç´¢æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œ

---

## ğŸ“Š ç·åˆè©•ä¾¡

### é”æˆçŠ¶æ³

| é …ç›® | çŠ¶æ…‹ | è©•ä¾¡ |
|-----|------|------|
| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£… | 14/14 (100%) | âœ… |
| åŸºæœ¬å‹•ä½œç¢ºèª | 8/14 (57%) | âš ï¸ |
| E2Eãƒ•ãƒ­ãƒ¼ | 1/1 (100%) | âœ… |
| å¾Œæ–¹äº’æ›æ€§ | 2/2 (100%) | âœ… |
| Choice Preservation | 4/4 (100%) | âœ… |

### é‡è¦ãªæˆæœ

1. **Choice Preservation APIå®Œå…¨å‹•ä½œ** âœ…
   - 4ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã™ã¹ã¦ãŒæ­£å¸¸ã«å‹•ä½œ
   - E2Eãƒ•ãƒ­ãƒ¼ãŒå®Œå…¨ã«å‹•ä½œ
   - å´ä¸‹ç†ç”±ã®ä¿å­˜æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œ

2. **å¾Œæ–¹äº’æ›æ€§ç¶­æŒ** âœ…
   - æ—¢å­˜ã®Messages APIãŒæ­£å¸¸ã«å‹•ä½œ
   - æ—¢å­˜ã®Intents APIãŒæ­£å¸¸ã«å‹•ä½œ
   - æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ãªã—

3. **åŸºæœ¬çš„ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå‹•ä½œ** âœ…
   - Contradiction Detectionï¼ˆä¸€éƒ¨ï¼‰
   - Dashboard Analyticsï¼ˆä¸€éƒ¨ï¼‰
   - ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…æ¸ˆã¿

### æ”¹å–„ãŒå¿…è¦ãªé …ç›®

1. **Memory Lifecycle API** âš ï¸
   - ImportanceScorerã®åˆæœŸåŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¿®æ­£ãŒå¿…è¦
   - å„ªå…ˆåº¦: é«˜

2. **Dashboard Analytics API** âš ï¸
   - SQLã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‹ä¿®æ­£ãŒå¿…è¦
   - å„ªå…ˆåº¦: ä¸­

3. **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æ•´å‚™** âš ï¸
   - æœ‰åŠ¹ãªUUIDå½¢å¼ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦
   - çŸ›ç›¾æ¤œå‡ºã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦
   - å„ªå…ˆåº¦: ä¸­

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### å„ªå…ˆåº¦: é«˜

1. **ImportanceScorerã®ä¿®æ­£**
```python
# backend/app/dependencies.py
scorer = ImportanceScorer(pool=pool)
```

2. **Memory Lifecycle APIã®å‹•ä½œç¢ºèª**
```bash
curl 'http://localhost:8000/api/v1/memory/lifecycle/status?user_id=test'
```

### å„ªå…ˆåº¦: ä¸­

3. **Dashboard Analytics APIã®ä¿®æ­£**
   - SQLã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‹ã‚’ç¢ºèª
   - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è©³ç´°ã«ç¢ºèª

4. **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ•´å‚™**
   - æœ‰åŠ¹ãªUUIDå½¢å¼ã®Intentã‚’ä½œæˆ
   - çŸ›ç›¾æ¤œå‡ºç”¨ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥

### å„ªå…ˆåº¦: ä½

5. **çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ**
   - pytestãƒ™ãƒ¼ã‚¹ã®è‡ªå‹•ãƒ†ã‚¹ãƒˆ
   - CI/CDçµ±åˆ

---

## ğŸ“ çµè«–

### ç·åˆåˆ¤å®š: âš ï¸ **éƒ¨åˆ†çš„ã«åˆæ ¼**

**ç†ç”±**:
- âœ… Choice Preservation APIã¯å®Œå…¨ã«å‹•ä½œï¼ˆ100%ï¼‰
- âœ… å¾Œæ–¹äº’æ›æ€§ã¯ç¶­æŒã•ã‚Œã¦ã„ã‚‹ï¼ˆ100%ï¼‰
- âœ… E2Eãƒ•ãƒ­ãƒ¼ã¯æ­£å¸¸ã«å‹•ä½œï¼ˆ100%ï¼‰
- âš ï¸ ä¸€éƒ¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å®Ÿè£…ã®ä¿®æ­£ãŒå¿…è¦ï¼ˆ57%ï¼‰

**è©•ä¾¡**:
- ä¸»è¦æ©Ÿèƒ½ï¼ˆChoice Preservationï¼‰ã¯å®Œå…¨ã«å‹•ä½œ
- æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ãªã—
- ä¸€éƒ¨ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§è»½å¾®ãªä¿®æ­£ãŒå¿…è¦
- å…¨ä½“çš„ã«ã¯é«˜å“è³ªãªå®Ÿè£…

**æ¨å¥¨äº‹é …**:
1. ImportanceScorerã®ä¿®æ­£ï¼ˆæœ€å„ªå…ˆï¼‰
2. Dashboard Analytics APIã®ä¿®æ­£
3. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ•´å‚™
4. å†ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

---

**ä½œæˆæ—¥**: 2025-11-30  
**æœ€çµ‚æ›´æ–°**: 2025-11-30  
**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ImportanceScorerä¿®æ­£ â†’ å†ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
